<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles_main.css" />
    <title>User Dashboard</title>
  </head>
  <body>
    <header>
      <h1>Welcome to the Dormitory Management System</h1>
      <p>User: <span id="userNamePlaceholder"></span></p>
    </header>

    <section>
      <h2>Available Rooms</h2>
      <table id="availableRooms">
        <thead>
          <tr>
            <th>Dormitory Name</th>
            <th>Room Number</th>
            <th>Size (sq.m)</th>
            <th>Monthly Rent (Baht/month)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Your Bookings</h2>
      <table id="userBookings">
        <thead>
          <tr>
            <th>Dormitory Name</th>
            <th>Room Number</th>
            <th>Start Date</th>
            <th>Cancel</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <div style="text-align: center; margin-top: 20px">
      <button id="bookButton" onclick="openBookingModal()">Book a Room</button>
    </div>

    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <form id="bookingForm">
          <label for="dormitory_name">Dormitory Name:</label>
          <select id="dormitory_name" name="dormitory_name" required></select>

          <label for="room_number">Room Number:</label>
          <select id="room_number" name="room_number" required></select>

          <label for="start_date">Start Date:</label>
          <input type="date" id="start_date" name="start_date" required />

          <button type="submit">Book</button>
        </form>
      </div>
    </div>

    <div id="cancelModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeCancelModal()">&times;</span>
        <form id="cancelForm">
          <label for="booking_id">Booking ID:</label>
          <input type="number" id="booking_id" name="booking_id" required />

          <button type="submit">Cancel Booking</button>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetchCurrentUserName();
        fetchAvailableRooms();
        fetchUserBookings(); // Fetch user bookings on page load

        const startDateInput = document.getElementById("start_date");
        const currentDate = new Date().toISOString().split("T")[0];
        startDateInput.min = currentDate;
      });

      function fetchCurrentUserName() {
        fetch("/api/currentUserName")
          .then((response) => response.json())
          .then((data) => {
            const userNameElement = document.getElementById(
              "userNamePlaceholder"
            );
            userNameElement.textContent = data.userName;
          })
          .catch((error) => {
            console.error("Error fetching user name:", error);
          });
      }

      function fetchAvailableRooms() {
        fetch("/api/rooms")
          .then((response) => response.json())
          .then((rooms) => {
            console.log("Received rooms data:", rooms); // Log the received data

            const tableBody = document
              .getElementById("availableRooms")
              .querySelector("tbody");
            tableBody.innerHTML = "";

            rooms.forEach((room) => {
              const values = [
                room["dormitory_name"],
                room["room_number"],
                room["size (sq.m)"],
                room["monthly_rent (baht)"],
              ];
              const row = createTableRow(values);
              tableBody.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error fetching available rooms:", error);
          });
      }

      function fetchUserBookings() {
        fetch("/api/userBookings")
          .then((response) => response.json())
          .then((bookings) => {
            const tableBody = document
              .getElementById("userBookings")
              .querySelector("tbody");
            tableBody.innerHTML = "";

            bookings.forEach((booking) => {
              const values = [
                booking["dormitory_name"],
                booking["room_number"],
                booking["start_date"],
                `<button onclick="cancelBooking(${booking["booking_id"]})">Cancel</button>`,
              ];
              const row = createTableRow(values);
              tableBody.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error fetching user bookings:", error);
          });
      }

      function createTableRow(values) {
        const row = document.createElement("tr");
        values.forEach((value) => {
          const cell = document.createElement("td");
          cell.textContent = value;
          row.appendChild(cell);
        });
        return row;
      }

      function openBookingModal() {
        const modal = document.getElementById("bookingModal");
        modal.style.display = "block";

        // Fetch available rooms when the modal is opened
        fetch("/api/rooms")
          .then((response) => response.json())
          .then((rooms) => {
            const dormitoryDropdown = document.getElementById("dormitory_name");
            const roomNumberDropdown = document.getElementById("room_number");

            // Clear previous options
            dormitoryDropdown.innerHTML = "";
            roomNumberDropdown.innerHTML = "";

            // Create a Set to get unique dormitory names
            const uniqueDormitories = new Set(
              rooms.map((room) => room.dormitory_name)
            );

            // Populate dormitory dropdown
            uniqueDormitories.forEach((dormitory) => {
              const option = document.createElement("option");
              option.value = dormitory;
              option.textContent = dormitory;
              dormitoryDropdown.appendChild(option);
            });

            // Add event listener to dormitory dropdown to populate room numbers when a dormitory is selected
            dormitoryDropdown.addEventListener("change", function () {
              const selectedDormitory = this.value;
              const availableRoomsForSelectedDormitory = rooms.filter(
                (room) => room.dormitory_name === selectedDormitory
              );

              // Clear previous room numbers
              roomNumberDropdown.innerHTML = "";

              // Populate room number dropdown
              availableRoomsForSelectedDormitory.forEach((room) => {
                const option = document.createElement("option");
                option.value = room.room_number;
                option.textContent = room.room_number;
                roomNumberDropdown.appendChild(option);
              });
            });

            // Trigger the change event to populate room numbers for the first dormitory by default
            dormitoryDropdown.dispatchEvent(new Event("change"));
          })
          .catch((error) => {
            console.error(
              "Error fetching available rooms for dropdown:",
              error
            );
          });
      }

      document
        .getElementById("bookingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const dormitoryName = formData.get("dormitory_name");
          const roomNumber = formData.get("room_number");
          const startDate = formData.get("start_date");

          const bookingDetails = {
            dormitory_name: dormitoryName,
            room_number: roomNumber,
            start_date: startDate,
          };

          const response = await fetch("/api/book", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(bookingDetails),
          });

          const result = await response.json();
          if (result.message === "Booking successful") {
            alert("Booking successful");
            closeModal();
            window.location.reload();
          } else {
            alert(result.message);
          }
        });

      function closeModal() {
        const modal = document.getElementById("bookingModal");
        modal.style.display = "none";
      }

      function openCancelModal() {
        const modal = document.getElementById("cancelModal");
        modal.style.display = "block";
      }

      function closeCancelModal() {
        const modal = document.getElementById("cancelModal");
        modal.style.display = "none";
      }

      async function cancelBooking(bookingId) {
        openCancelModal();
        document.getElementById("booking_id").value = bookingId;
      }

      document
        .getElementById("cancelForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const bookingId = formData.get("booking_id");

          const response = await fetch(`/api/cancelBooking/${bookingId}`, {
            method: "POST",
          });

          const result = await response.json();
          if (result.message === "Booking cancellation successful") {
            alert("Booking cancellation successful");
            closeCancelModal();
            window.location.reload();
          } else {
            alert(result.message);
          }
        });
    </script>
  </body>
</html>
